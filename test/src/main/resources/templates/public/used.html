<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout_public}">

<head>
	<meta charset="utf-8">
	<title>used</title>
	<link href="../../css/sidemenu.css" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<style>
		.all-container {
			padding-left: 10%;
			padding-right: 10%;
		}

		.retro-container {
			background-color: #fff;
			border: 1px solid #ddd;
			padding: 5%;
			margin: 20px auto;
			max-width: 1000px;
			box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
			display: flex;
			/* 이미지와 정보를 가로로 나란히 배치하기 위해 flex 사용 */
		}

		.retro-title {
			font-size: 40px;
			margin-left: 50px;
			margin-top: 0px;
		}

		.retro-price {
			font-size: 40px;
			margin-left: 50px;
			margin-top: -40px;
		}

		.retro-content {
			margin-left: 50px;
			margin-top: -40px;
		}

		.retro-date {
			margin-left: 50px;

		}

		.product-img {}

		.waringmessage {
			padding: 5%;
			margin: 20px auto;
			text-align: center;
			width: 800px;
			background-color: rgb(240, 240, 240);

		}

		.text11 {
			border-bottom: solid 1px;
			border-width: 10%;

		}

		.text-form {
			text-align: center;
			margin-top: -50px;
		}

		.content33 {
			border: 1px solid rgb(192, 192, 192);
			padding: 5%;
			margin: 3px auto;
			height: auto;
			max-width: 800px;
			box-shadow: 0 0 5px rgb(192, 192, 192);
			display: flex;

		}

		.content11 {
			margin-top: -50px;
			margin-right: 20px;
		}

		.text2 {
			margin-left: 50px;
			margin-top: 40px;
		}

		.text3 {
			margin-left: 130px;
			margin-top: -15px;
			margin-bottom: 50px;
		}

		.clicked-button {
			background-color: lightblue;
			color: white;
			font-weight: bold;
			/* 원하는 스타일을 여기에 추가하세요 */
		}

		.replyInput {
			visibility: hidden;
		}

		.my-class-0 {
			background-color: rgb(240, 240, 240);
		}

		.my-class-1 {
			background-color: rgb(240, 240, 240);
		}

		.my-class-2 {
			background-color: rgb(39, 120, 94);
		}

		.my-class-3 {
			background-color: rgb(173, 36, 36);
		}

		.slideshow-container {
			position: relative;
			max-width: 100%;
			margin: auto;
		}

		.mySlides {
			display: none;
		}

		.prev,
		.next {
			position: absolute;
			top: 50%;
			transform: translateY(-50%);
			padding: 10px;
			font-size: 30px;
			cursor: pointer;
			color: rgb(0, 0, 0);
		}

		.prev {
			left: 0;
		}

		.next {
			right: 0;
		}

		.used-title {
			margin-right: 40px;
		}

		input {
			width: 750px;
			height: 100px;
			font-size: 20px;
			border: 1px solid lightgray;
		}

		.comment-container {
			padding: 5%;
			margin: 20px auto;

			width: 800px;
			height: auto;

			padding: 20px;
			border: 1px solid #ccc;
			border-radius: 5px;



		}

		.used-comment {
			border: 1px solid #ddd;
			padding: 10px;
			margin: 5px 0;
			border-radius: 5px;
			background-color: #fff;

		}

		.used-comment p {

			font-weight: bold;

		}

		.used-comment p:first-child {
			color: black;
		}

		.used-comment p:last-child {
			color: #333;
			/* Dark gray color for content */
		}

		.commentwrite {
			margin-top: 20px;
		}

		.co-title {
			font-weight: bold;
		}

		.buttons {
			float: right;
			justify-content: right;
			margin-top: 10px;
			background-color: rgb(0, 0, 0);
			color: rgb(255, 255, 255);
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}

		.buttons:hover {
			background-color: rgb(192, 192, 192);
		}

		.comment {
			font-size: 40px;
			text-align: center;
		}

		.pro {
			width: 30px;
			height: 30px;
		}
	</style>
</head>

<body>


	<div layout:fragment="content">
		<div class="all-container">
			<div class="retro-container">


				<div class="slideshow-container">
					<div th:each="productImgDto, status: ${used.usedImgList}">
						<div th:unless="${#strings.isEmpty(productImgDto.imgUrl)}">
							<div class="mySlides">
								<input type="hidden" name="productImgIds" th:value="${productImgDto.id}">
								<img class="product-image" th:src="${productImgDto.imgUrl}" width="500" height="500">
							</div>
						</div>
					</div>


					<a class="prev" onclick="plusSlides(-1)">&#10094;</a>

					<a class="next" onclick="plusSlides(1)">&#10095;</a>
				</div>




				<div class="used-title">
					<button type="button" onclick="product()">상품보기</button>
					<input type="hidden" id="idValue" th:value="${used.id}">
					<p class="retro-title" th:text="${used.title}">제목</p><br>
					<p class="retro-price" th:text="${used.price}+'원'">가격</p><br>
					<p class="text2"><b>결제혜택</b> : 중고나라 페이 첫 결제 혜택<br></p>
					<p class="text3">
						CU 알뜰택배 무료배송<br>
						세븐일레븐 편의점 택배 무료<br>
						편의점 픽업 수수료 무료</p>

					<span class="retro-date"><b>구매 한 날짜:</b> </span><span class="retro-date1"
						th:text="${#temporals.format(used.orderProduct.order.orderDate, 'yyyy-MM-dd')}">주문 내역</span>
					


				</div>
			</div>
			<div class="waringmessage">
				<div class="text-form">
					<p>
					<h3 style="color: red; text-align: center;">거래 전 주의사항 안내</h3><br>
					판매자가 별도의 메신저로 결제링크를 보내거나 직거래(직접송금)을<br>
					유도하는 경우 사기일 가능성이 높으니 거래를 자제해 주시고<br>
					<p class="text11">HENRY IV 고객센터로 신고해주시기 바랍니다.</p>
				</div>
			</div>
			<div class="content33">
				<p class="content1" th:text="'내용 : '+${used.content}">내용</p>
			</div>

			<div class="comment-container">
				<!--
					댓글목록	
				-->
				<p class="comment">COMMENT</p>
				<div>

					<table>

						<div th:each="usedComment, index: ${usedCommentList}">
							<div class="used-comment" th:if="${username == usedComment.user.username or username == used.orderProduct.order.user.username
										 or usedComment.user.username == used.orderProduct.order.user.username}">
								<div>
									<span><img class="pro" th:src="@{/resources/img/pro.png}"></span>
									<span th:text="${usedComment.user.username}+''">유저이름</span>
								</div>
								<p th:text="${usedComment.content}">내용</p>
								<span th:text="${#temporals.format(usedComment.commentDate, 'yyyy-MM-dd HH:mm')}"></span>
							</div>
							<div class="used-comment" th:unless="${username == usedComment.user.username or username == used.orderProduct.order.user.username
										 or usedComment.user.username == used.orderProduct.order.user.username}">
								<span th:text="${usedComment.user.username}+' : '">유저이름</span>
								<span>글 작성자와 댓글 작성자만 확인가능합니다</span>
								<span th:text="${#temporals.format(usedComment.commentDate, 'yyyy-MM-dd HH:mm')}"></span>
							</div>
						</div>
					</table>

				</div>
				<!--
					댓글작성
				-->
				<div class="commentwrite">

					<span class="co-title" for="message">내용</span>
					<input type="text" name="content" id="content">
					<button class="buttons" onclick="comment()">댓글쓰기</button>

				</div>
			</div>
			<!--
				<th:block th:with="counter=0">
					<div th:each="usedComment, index: ${usedCommentList}">
						<tr>
							<div th:if="${usedComment.reply_user eq null}">
								<th:block th:with="counter=0">
								</th:block>
								<input type="hidden" th:id="'userId' + ${usedComment.id}"
									th:value="${usedComment.user.username}">
								<span th:text="${usedComment.user.username}+' : '">유저이름</span>
								<span th:text="${usedComment.content}">내용</span>
								<button th:id="'btn' + ${usedComment.id}">답글</button>
								<div th:id="'div' + ${usedComment.id}" class="replyInput">
									<input type="text" name="reply_content" th:id="'content' + ${usedComment.id}">
									<input type="hidden" th:id="'commentId' + ${usedComment.id}"
										th:value="${usedComment.id}">
									<button th:id="'btnsave' + ${usedComment.id}">답글쓰기</button>
								</div>
							</div>
							<div th:unless="${usedComment.reply_user eq null}" th:classappend="'my-class-'+${counter}">
								<th:block th:with="counter=${counter + 1}">
								</th:block>
								<input type="hidden" th:id="'userId' + ${usedComment.id}"
									th:value="${usedComment.user.username}">
								<span th:text="${usedComment.user.username}+' : '">유저이름</span>
								<span th:text="${usedComment.content}">내용</span>
								<button th:id="'btn' + ${usedComment.id}">답글</button>
								<div th:id="'div' + ${usedComment.id}" class="replyInput">
									<input type="text" name="reply_content" th:id="'content' + ${usedComment.id}">
									<input type="hidden" th:id="'commentId' + ${usedComment.id}"
										th:value="${usedComment.id}">
									<button th:id="'btnsave' + ${usedComment.id}">답글쓰기</button>
								</div>
							</div>
						</tr>
					</div>
				</th:block>
				-->




			<div class="sidemenu">
				<ul>
					<li><a href="/public/usedList">중고마켓</a></li>
					<li><a href="/protected/questionForm">1:1문의</a></li>
					<li><a href="/protected/order">주문조회</a></li>
				</ul>
				<ul>
					<li><a href="https://open.kakao.com/o/sdxxCZQf"><img class="kakao"
								th:src="@{/resources/img/kakao.PNG}"></a></li>

				</ul>
			</div>

			<script th:inline="javascript">
				$(document).ready(function () {
					var currentPosition = parseInt($(".sidemenu").css("top"));
					$(window).scroll(function () {
						var position = $(window).scrollTop();
						$(".sidemenu").stop().animate({ "top": position + currentPosition + "px" }, 600);
					});
				});

				function product() {
					var productId = /*[[${used.orderProduct.product.id}]]*/ null;
					window.location.href = "/public/product/" + productId;
				}
				/*
				$(document).ready(function () {
					// 각 버튼에 대한 이벤트 핸들러를 추가합니다.
					$('[id^="btn"]').on('click', function () {
						// 버튼을 클릭할 때 연결된 reply_content의 visibility를 변경합니다.
						var replyId = $(this).attr("id").replace("btn", "div");
						var replyInput = $("#" + replyId);
						replyInput.css("visibility", "visible");
	
					});
	
					// '답글쓰기' 버튼에 대한 이벤트 핸들러
					$('[id^="btnsave"]').on('click', function () {
						var commentId = $(this).attr("id").replace("btnsave", "");
						var contentId = "content" + commentId;
						var userId = "userId" + commentId;
	
						var contentValue = $("#" + contentId).val();
						var userIdValue = $("#" + userId).val();
	
						// 이제 commentIdValue, contentValue 및 userIdValue를 사용하여 Ajax 요청 데이터를 구성합니다.
						var id = $("#idValue").val();
						var token = $("meta[name='_csrf']").attr("content");
						var header = $("meta[name='_csrf_header']").attr("content");
						var url = "/public/used/" + id + "/reply_comment";
	
						// Ajax 요청을 보냅니다.
						$.ajax({
							url: url,
							type: "POST",
							beforeSend: function (xhr) {
								xhr.setRequestHeader(header, token);
							},
							dataType: "json",
							cache: false,
							data: {
								"content": contentValue,
								"reply_user": userIdValue // 유저 ID 추가
							},
							success: function (result, status) {
								alert("댓글작성");
								location.href = "/public/used/" + id;
							},
							error: function (jqXHR, status, error) {
								alert("댓글작성");
								location.href = "/public/used/" + id;
							}
						});
					});
	
				});
				*/

				function comment() {
					var content = $("#content").val();
					var id = $("#idValue").val();

					var token = $("meta[name='_csrf']").attr("content");
					var header = $("meta[name='_csrf_header']").attr("content");

					var url = "/public/used/" + id + "/comment";

					if (content.trim() === "") {
						alert("댓글 내용을 입력해주세요.");
					} else {
						$.ajax({
							url: url,
							type: "POST",
							beforeSend: function (xhr) {
								xhr.setRequestHeader(header, token);
							},
							dataType: "json",
							cache: false,
							data: { "content": content },
							success: function (result, status) {
								location.href = "/public/used/" + id;
							},
							error: function (jqXHR, status, error) {
								location.href = "/public/used/" + id;
							}
						});
					}
				}

				var slideIndex = 0;
				var totalPages = document.getElementsByClassName("mySlides").length; // 전체 슬라이드 수

				showSlides();


				function plusSlides(n) {
					slideIndex += n;
					showSlides();
				}


				function showSlides() {
					var i;
					var slides = document.getElementsByClassName("mySlides");

					if (slideIndex >= slides.length) {
						slideIndex = 0;
					} else if (slideIndex < 0) {
						slideIndex = slides.length - 1;
					}

					for (i = 0; i < slides.length; i++) {
						slides[i].style.display = "none";
					}

					slides[slideIndex].style.display = "block";
				}

			</script>
		</div>
	</div>
</body>

</html>